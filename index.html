<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram群组用户转移工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb',
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444',
                    },
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <header class="text-center mb-10">
            <h1 class="text-2xl md:text-3xl font-bold mb-2">
                <i class="fa fa-telegram text-primary mr-2"></i>Telegram群组用户转移工具
            </h1>
            <p class="text-gray-600">轻松将成员从一个群组转移到另一个群组</p>
        </header>

        <main class="bg-white rounded-xl shadow p-6 md:p-8 mb-8">
            <!-- 群组设置 -->
            <div class="mb-8">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fa fa-group text-primary mr-2"></i>群组设置
                </h2>
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">源群组ID</label>
                        <input 
                            type="text" 
                            id="sourceGroup" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all"
                            placeholder="例如: -2651659549"
                            value="-2651659549"
                        >
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">目标群组ID</label>
                        <input 
                            type="text" 
                            id="targetGroup" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all"
                            placeholder="例如: -1002735235059"
                            value="-1002735235059"
                        >
                    </div>
                </div>
            </div>

            <!-- Worker地址配置（新增） -->
            <div class="mb-8">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fa fa-link text-primary mr-2"></i>Worker配置
                </h2>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Worker API地址</label>
                    <input 
                        type="text" 
                        id="workerApiUrl" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all"
                        placeholder="例如: https://proxy-7391.your-subdomain.workers.dev"
                        value="https://proxy-7391.your-account-subdomain.workers.dev"
                    >
                    <p class="text-xs text-gray-500 mt-1">https://telegram-laren.bingkuijing.workers.dev/</p>
                </div>
            </div>

            <!-- 操作按钮 -->
            <div class="mb-8 text-center">
                <button 
                    id="startTransfer" 
                    class="bg-primary hover:bg-primary/90 text-white font-medium px-6 py-3 rounded-lg shadow hover:shadow-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    <i class="fa fa-play mr-2"></i>开始转移用户
                </button>
            </div>

            <!-- 转移状态 -->
            <div class="mb-8">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fa fa-bar-chart text-primary mr-2"></i>转移状态
                </h2>
                <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                    <div class="mb-4">
                        <div class="flex justify-between text-sm mb-1">
                            <span>转移进度</span>
                            <span id="progressPercent">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3">
                            <div id="progressBar" class="bg-primary h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                        <div class="bg-blue-50 p-3 rounded-lg">
                            <p class="text-sm text-gray-600">总用户数</p>
                            <p id="totalUsers" class="text-xl font-semibold text-primary">0</p>
                        </div>
                        <div class="bg-green-50 p-3 rounded-lg">
                            <p class="text-sm text-gray-600">已转移</p>
                            <p id="transferredUsers" class="text-xl font-semibold text-success">0</p>
                        </div>
                        <div class="bg-yellow-50 p-3 rounded-lg">
                            <p class="text-sm text-gray-600">已跳过</p>
                            <p id="skippedUsers" class="text-xl font-semibold text-warning">0</p>
                        </div>
                        <div class="bg-purple-50 p-3 rounded-lg">
                            <p class="text-sm text-gray-600">状态</p>
                            <p id="transferStatus" class="text-xl font-semibold text-gray-600">未开始</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 操作日志 -->
            <div>
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fa fa-history text-primary mr-2"></i>操作日志
                </h2>
                <div id="logContainer" class="bg-gray-900 text-gray-200 rounded-lg p-4 h-60 overflow-y-auto text-sm font-mono">
                    <p class="text-gray-400">等待操作开始...</p>
                </div>
            </div>
        </main>

        <footer class="text-center text-gray-500 text-sm">
            <p>使用前请确保已获得群组管理员授权 | 遵守Telegram使用条款</p>
        </footer>
    </div>

    <script>
        // 从输入框获取Worker地址（允许用户动态修改）
        function getApiBaseUrl() {
            return document.getElementById('workerApiUrl').value.trim().replace(/\/$/, '');
        }

        let statusPollInterval = null;

        // DOM元素
        const startBtn = document.getElementById('startTransfer');
        const progressBar = document.getElementById('progressBar');
        const progressPercent = document.getElementById('progressPercent');
        const totalUsers = document.getElementById('totalUsers');
        const transferredUsers = document.getElementById('transferredUsers');
        const skippedUsers = document.getElementById('skippedUsers');
        const transferStatus = document.getElementById('transferStatus');
        const logContainer = document.getElementById('logContainer');
        const sourceGroupInput = document.getElementById('sourceGroup');
        const targetGroupInput = document.getElementById('targetGroup');
        const workerApiInput = document.getElementById('workerApiUrl');

        // 添加日志（支持不同级别）
        function addLog(message, isError = false) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('p');
            logEntry.className = isError ? 'text-danger' : '';
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // 验证Worker地址
        function validateWorkerUrl() {
            const url = getApiBaseUrl();
            if (!url) {
                addLog('错误：请填写Worker API地址', true);
                return false;
            }
            try {
                new URL(url);
                return true;
            } catch (e) {
                addLog('错误：Worker API地址格式不正确', true);
                return false;
            }
        }

        // 更新状态显示
        function updateStatus(status) {
            progressBar.style.width = `${status.progress || 0}%`;
            progressPercent.textContent = `${status.progress || 0}%`;
            totalUsers.textContent = status.total || 0;
            transferredUsers.textContent = status.transferred || 0;
            skippedUsers.textContent = status.skipped || 0;

            if (status.in_progress) {
                transferStatus.textContent = '转移中';
                transferStatus.className = 'text-xl font-semibold text-primary';
                startBtn.disabled = true;
            } else {
                if (status.progress === 100) {
                    transferStatus.textContent = '已完成';
                    transferStatus.className = 'text-xl font-semibold text-success';
                } else {
                    transferStatus.textContent = '未开始';
                    transferStatus.className = 'text-xl font-semibold text-gray-600';
                }
                startBtn.disabled = false;
            }
        }

        // 处理CORS预检请求
        async function handlePreflight(url) {
            try {
                const response = await fetch(url, {
                    method: 'OPTIONS',
                    mode: 'cors',
                    headers: {
                        'Access-Control-Request-Method': 'GET, POST',
                        'Access-Control-Request-Headers': 'Content-Type',
                        'Origin': window.location.origin
                    }
                });
                return response.ok;
            } catch (error) {
                addLog(`预检请求失败: ${error.message}`, true);
                return false;
            }
        }

        // 获取当前状态
        async function getStatus() {
            if (!validateWorkerUrl()) return;
            
            const apiUrl = `${getApiBaseUrl()}/status`;
            
            try {
                // 执行预检请求
                const preflightOk = await handlePreflight(apiUrl);
                if (!preflightOk) {
                    addLog('CORS预检失败，无法获取状态', true);
                    return;
                }
                
                // 发送实际请求
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    }
                });
                
                const responseText = await response.text();
                
                if (!response.ok) {
                    addLog(`获取状态失败 (${response.status}): ${responseText}`, true);
                    return;
                }
                
                // 解析响应
                try {
                    const status = JSON.parse(responseText);
                    updateStatus(status);
                    return status;
                } catch (e) {
                    addLog(`服务器返回非JSON格式: ${responseText}`, true);
                }
            } catch (error) {
                addLog(`获取状态时发生错误: ${error.message}`, true);
                if (error.message.includes('CORS')) {
                    addLog('提示：请检查Worker的CORS配置是否包含当前域名', true);
                } else if (error.message.includes('404')) {
                    addLog('提示：Worker地址不正确或未部署', true);
                }
            }
        }

        // 开始转移
        async function startTransfer() {
            if (!validateWorkerUrl()) return;
            
            const sourceGroup = sourceGroupInput.value.trim();
            const targetGroup = targetGroupInput.value.trim();

            if (!sourceGroup || !targetGroup) {
                addLog('错误：请输入源群组和目标群组ID', true);
                return;
            }

            const apiUrl = `${getApiBaseUrl()}/transfer`;
            
            try {
                // 执行预检请求
                const preflightOk = await handlePreflight(apiUrl);
                if (!preflightOk) {
                    addLog('CORS预检失败，无法开始转移', true);
                    return;
                }
                
                // 准备FormData
                const formData = new FormData();
                formData.append('source', sourceGroup);
                formData.append('target', targetGroup);

                // 发送请求
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    mode: 'cors',
                    body: formData
                });

                const responseText = await response.text();
                
                if (!response.ok) {
                    addLog(`转移请求失败 (${response.status}): ${responseText}`, true);
                    return;
                }

                addLog('转移请求已发送，开始处理...');
                startStatusPolling();
            } catch (error) {
                addLog(`开始转移时发生错误: ${error.message}`, true);
                if (error.message.includes('CORS')) {
                    addLog('提示：Worker的CORS配置可能不正确', true);
                } else if (error.message.includes('404')) {
                    addLog('提示：Worker地址错误或接口不存在', true);
                }
            }
        }

        // 开始轮询状态
        function startStatusPolling() {
            if (statusPollInterval) clearInterval(statusPollInterval);
            getStatus(); // 立即获取一次
            statusPollInterval = setInterval(async () => {
                const status = await getStatus();
                // 如果转移完成，停止轮询
                if (status && !status.in_progress && status.progress === 100) {
                    clearInterval(statusPollInterval);
                    statusPollInterval = null;
                    addLog('转移已完成！');
                }
            }, 3000);
        }

        // 事件监听
        startBtn.addEventListener('click', startTransfer);
        workerApiInput.addEventListener('change', () => {
            addLog('Worker地址已更新，点击"开始转移"重新尝试');
        });

        // 页面加载时初始化
        window.addEventListener('load', () => {
            addLog('页面已加载，准备就绪');
            // 检查默认地址
            if (getApiBaseUrl().includes('your-account-subdomain')) {
                addLog('警告：请替换默认的Worker API地址为您的实际地址', true);
            } else {
                getStatus(); // 自动获取一次状态
            }
        });
    </script>
</body>
</html>
    
