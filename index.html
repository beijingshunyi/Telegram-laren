<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram群组用户转移工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb',
                        secondary: '#64748b',
                        success: '#10b981',
                        danger: '#ef4444',
                        dark: '#1e293b',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .shadow-soft {
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            }
            .transition-all-300 {
                transition: all 300ms ease-in-out;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <header class="text-center mb-10">
            <h1 class="text-[clamp(1.8rem,5vw,2.5rem)] font-bold text-dark mb-2">
                <i class="fa fa-telegram text-primary mr-3"></i>Telegram万花楼群组用户转移工具
            </h1>
            <p class="text-secondary text-lg">轻松将成员从一个群组转移到另一个群组</p>
        </header>

        <main class="bg-white rounded-xl shadow-soft p-6 md:p-8 mb-8">
            <!-- 群组ID输入区域 -->
            <div class="mb-8">
                <h2 class="text-xl font-semibold text-dark mb-4 flex items-center">
                    <i class="fa fa-cogs text-primary mr-2"></i>群组设置
                </h2>
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <label for="sourceGroup" class="block text-sm font-medium text-gray-700 mb-1">源群组ID</label>
                        <input 
                            type="text" 
                            id="sourceGroup" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all-300"
                            placeholder="例如: -2651659549"
                            value="-2651659549"
                        >
                    </div>
                    <div>
                        <label for="targetGroup" class="block text-sm font-medium text-gray-700 mb-1">目标群组ID</label>
                        <input 
                            type="text" 
                            id="targetGroup" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all-300"
                            placeholder="例如: -1002735235059"
                            value="-1002735235059"
                        >
                    </div>
                </div>
            </div>

            <!-- 控制按钮区域 -->
            <div class="mb-8 text-center">
                <button 
                    id="startTransfer" 
                    class="bg-primary hover:bg-primary/90 text-white font-medium px-8 py-3 rounded-lg shadow-md hover:shadow-lg transition-all-300 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center mx-auto"
                >
                    <i class="fa fa-play mr-2"></i>开始转移用户
                </button>
                <button 
                    id="stopTransfer" 
                    class="bg-danger hover:bg-danger/90 text-white font-medium px-8 py-3 rounded-lg shadow-md hover:shadow-lg transition-all-300 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center mx-auto mt-4 hidden"
                >
                    <i class="fa fa-stop mr-2"></i>停止转移
                </button>
            </div>

            <!-- 状态显示区域 -->
            <div class="mb-8">
                <h2 class="text-xl font-semibold text-dark mb-4 flex items-center">
                    <i class="fa fa-bar-chart text-primary mr-2"></i>转移状态
                </h2>
                <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                    <div class="mb-4">
                        <div class="flex justify-between text-sm mb-1">
                            <span>转移进度</span>
                            <span id="progressPercent">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3">
                            <div id="progressBar" class="bg-primary h-3 rounded-full transition-all-300" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                        <div class="bg-blue-50 p-3 rounded-lg">
                            <p class="text-sm text-gray-600">总用户数</p>
                            <p id="totalUsers" class="text-xl font-semibold text-primary">0</p>
                        </div>
                        <div class="bg-green-50 p-3 rounded-lg">
                            <p class="text-sm text-gray-600">已转移</p>
                            <p id="transferredUsers" class="text-xl font-semibold text-success">0</p>
                        </div>
                        <div class="bg-yellow-50 p-3 rounded-lg">
                            <p class="text-sm text-gray-600">已跳过</p>
                            <p id="skippedUsers" class="text-xl font-semibold text-yellow-500">0</p>
                        </div>
                        <div class="bg-purple-50 p-3 rounded-lg">
                            <p class="text-sm text-gray-600">状态</p>
                            <p id="transferStatus" class="text-xl font-semibold text-secondary">未开始</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 日志显示区域 -->
            <div>
                <h2 class="text-xl font-semibold text-dark mb-4 flex items-center">
                    <i class="fa fa-history text-primary mr-2"></i>操作日志
                </h2>
                <div id="logContainer" class="bg-gray-900 text-gray-200 rounded-lg p-4 h-60 overflow-y-auto text-sm font-mono">
                    <p class="text-gray-400">等待操作开始...</p>
                </div>
            </div>
        </main>

        <footer class="text-center text-gray-500 text-sm">
            <p>© 2025 Telegram群组工具 | 注意：请遵守Telegram使用条款</p>
        </footer>
    </div>

    <script>
        // 修复：使用正确的Worker地址，确保末尾没有斜杠
        const API_BASE_URL = 'https://telegram-laren.bingkuijing.workers.dev';
        let statusPollInterval = null;

        // DOM元素
        const startBtn = document.getElementById('startTransfer');
        const stopBtn = document.getElementById('stopTransfer');
        const progressBar = document.getElementById('progressBar');
        const progressPercent = document.getElementById('progressPercent');
        const totalUsers = document.getElementById('totalUsers');
        const transferredUsers = document.getElementById('transferredUsers');
        const skippedUsers = document.getElementById('skippedUsers');
        const transferStatus = document.getElementById('transferStatus');
        const logContainer = document.getElementById('logContainer');
        const sourceGroupInput = document.getElementById('sourceGroup');
        const targetGroupInput = document.getElementById('targetGroup');

        // 添加日志
        function addLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('p');
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // 更新状态显示
        function updateStatus(status) {
            progressBar.style.width = `${status.progress}%`;
            progressPercent.textContent = `${status.progress}%`;
            totalUsers.textContent = status.total;
            transferredUsers.textContent = status.transferred;
            skippedUsers.textContent = status.skipped;

            if (status.in_progress) {
                transferStatus.textContent = '转移中';
                transferStatus.className = 'text-xl font-semibold text-primary';
                startBtn.disabled = true;
                stopBtn.classList.remove('hidden');
            } else {
                if (status.progress === 100) {
                    transferStatus.textContent = '已完成';
                    transferStatus.className = 'text-xl font-semibold text-success';
                } else {
                    transferStatus.textContent = '未开始';
                    transferStatus.className = 'text-xl font-semibold text-secondary';
                }
                startBtn.disabled = false;
                stopBtn.classList.add('hidden');
            }
        }

        // 获取当前状态 - 增强错误处理
        async function getStatus() {
            try {
                // 修复：正确拼接URL，避免双斜杠
                const response = await fetch(`${API_BASE_URL}/status`);
                
                // 先检查HTTP状态码
                if (!response.ok) {
                    const errorText = await response.text();
                    addLog(`服务器错误 (${response.status}): ${errorText}`);
                    return;
                }
                
                // 尝试解析JSON，失败时捕获错误
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    const status = await response.json();
                    updateStatus(status);
                    return status;
                } else {
                    const text = await response.text();
                    addLog(`服务器返回非JSON数据: ${text}`);
                }
            } catch (error) {
                addLog(`错误：无法获取状态 - ${error.message}`);
                console.error('Status error:', error);
            }
        }

        // 开始转移 - 增强错误处理
        async function startTransfer() {
            const sourceGroup = sourceGroupInput.value.trim();
            const targetGroup = targetGroupInput.value.trim();

            if (!sourceGroup || !targetGroup) {
                addLog('错误：请输入源群组和目标群组ID');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/transfer`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        source_group_id: sourceGroup,
                        target_group_id: targetGroup
                    })
                });

                // 检查HTTP状态码
                if (!response.ok) {
                    const errorText = await response.text();
                    addLog(`转移请求失败 (${response.status}): ${errorText}`);
                    return;
                }

                // 处理响应
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    const result = await response.json();
                    addLog('开始转移用户...');
                    startStatusPolling();
                } else {
                    const text = await response.text();
                    addLog(`转移响应: ${text}`);
                    startStatusPolling();
                }
            } catch (error) {
                addLog(`错误：开始转移失败 - ${error.message}`);
                console.error('Start transfer error:', error);
            }
        }

        // 开始轮询状态
        function startStatusPolling() {
            if (statusPollInterval) clearInterval(statusPollInterval);
            getStatus(); // 立即获取一次
            statusPollInterval = setInterval(async () => {
                const status = await getStatus();
                if (status && !status.in_progress && status.progress === 100) {
                    addLog('转移已完成！');
                    clearInterval(statusPollInterval);
                    statusPollInterval = null;
                }
            }, 3000); // 每3秒查询一次
        }

        // 事件监听
        startBtn.addEventListener('click', startTransfer);
        stopBtn.addEventListener('click', () => {
            addLog('提示：当前版本不支持中途停止，请等待完成');
        });

        // 页面加载时获取一次状态
        window.addEventListener('load', () => {
            addLog('页面已加载，准备就绪');
            getStatus();
        });
    </script>
</body>
</html>
    
