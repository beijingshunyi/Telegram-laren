<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram 群组用户转移控制台</title>
    <style>
        /* iOS风格样式 */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #f2f2f7;
            color: #000;
            line-height: 1.47059;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }
        .card {
            background-color: #fff;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .card h2 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 12px;
        }
        .form-group {
            margin-bottom: 12px;
        }
        label {
            display: block;
            font-size: 16px;
            margin-bottom: 4px;
        }
        input[type="text"], input[type="number"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d1d6;
            border-radius: 8px;
            font-size: 16px;
        }
        button {
            background-color: #007aff;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
        }
        button:hover {
            background-color: #005ecb;
        }
        .button-group {
            display: flex;
            gap: 10px;
        }
        .button-group button {
            flex: 1;
        }
        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #e5e5ea;
        }
        .list-item:last-child {
            border-bottom: none;
        }
        .list-item button {
            background-color: #ff3b30;
            padding: 6px 12px;
            font-size: 14px;
            width: auto;
        }
        .logs {
            max-height: 400px;
            overflow-y: auto;
        }
        .log-item {
            padding: 8px 12px;
            border-bottom: 1px solid #e5e5ea;
            font-size: 14px;
        }
        .log-item.success {
            color: #34c759;
        }
        .log-item.failed {
            color: #ff3b30;
        }
        .log-item.skipped {
            color: #ff9500;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-running {
            background-color: #34c759;
        }
        .status-stopped {
            background-color: #ff3b30;
        }
        .error-message {
            color: #ff3b30;
            margin-top: 10px;
            padding: 10px;
            background-color: #ffebee;
            border-radius: 8px;
            display: none;
        }
        .api-config {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e5e5ea;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Telegram 群组用户转移控制台</h1>
        </div>

        <!-- API配置 -->
        <div class="card">
            <h2>API配置</h2>
            <div class="form-group">
                <label for="apiUrl">API基础地址</label>
                <input type="text" id="apiUrl" value="https://telegram-laren.bingkuijing.workers.dev" placeholder="例如：https://your-worker.your-subdomain.workers.dev">
            </div>
            <button onclick="saveApiConfig()">保存API配置</button>
            <div id="apiError" class="error-message"></div>
        </div>

        <!-- 群组配置 -->
        <div class="card">
            <h2>群组配置</h2>
            <div class="form-group">
                <label for="sourceChat">源群组ID（多个用逗号分隔）</label>
                <input type="text" id="sourceChat" placeholder="例如：-1001234567890,-1000987654321">
            </div>
            <div class="form-group">
                <label for="targetChat">目标群组ID</label>
                <input type="text" id="targetChat" placeholder="例如：-1001234567890">
            </div>
            <button onclick="saveConfig()">保存配置</button>
            <div id="configError" class="error-message"></div>
        </div>

        <!-- 当前配置 -->
        <div class="card">
            <h2>当前配置</h2>
            <div id="currentConfig">
                <p>源群组：<span id="currentSource">未设置</span></p>
                <p>目标群组：<span id="currentTarget">未设置</span></p>
                <p>运行状态：<span id="runningStatus"><span class="status-indicator status-stopped"></span>已停止</span></p>
            </div>
            <div class="button-group">
                <button onclick="startTransfer()">开始转移</button>
                <button onclick="stopTransfer()">停止转移</button>
            </div>
            <div id="transferError" class="error-message"></div>
        </div>

        <!-- 操作日志 -->
        <div class="card">
            <h2>操作日志</h2>
            <div class="logs" id="logsList">
                <!-- 日志将动态加载 -->
            </div>
            <div id="logsError" class="error-message"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script>
        // 全局变量
        let supabase = null;
        let SUPABASE_URL = 'https://telegram-laren.bingkuijing.workers.dev';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im10bmR4ZnF4aXZnaXZid2FtamduIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyNDc1MDQsImV4cCI6MjA3MzgyMzUwNH0.s7LQxin9OyNLUTQsrv0EK1z60CcmqhyGAjDY-A17Yy0';

        // 初始化Supabase
        function initSupabase() {
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                hideError('apiError');
                return true;
            } catch (error) {
                showError('apiError', '初始化Supabase失败: ' + error.message);
                return false;
            }
        }

        // 显示错误信息
        function showError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }

        // 隐藏错误信息
        function hideError(elementId) {
            const errorElement = document.getElementById(elementId);
            errorElement.style.display = 'none';
        }

        // 保存API配置
        function saveApiConfig() {
            SUPABASE_URL = document.getElementById('apiUrl').value.trim();
            if (!SUPABASE_URL) {
                showError('apiError', '请输入API基础地址');
                return;
            }
            
            // 保存到localStorage
            localStorage.setItem('apiUrl', SUPABASE_URL);
            
            // 重新初始化Supabase
            if (initSupabase()) {
                alert('API配置保存成功');
                // 重新加载配置和日志
                loadConfig();
                loadLogs();
            }
        }

        // 保存配置
        async function saveConfig() {
            if (!supabase && !initSupabase()) {
                return;
            }

            const sourceChats = document.getElementById('sourceChat').value.split(',').map(id => id.trim()).filter(id => id);
            const targetChat = document.getElementById('targetChat').value.trim();

            if (!targetChat) {
                showError('configError', '请输入目标群组ID');
                return;
            }

            try {
                // 检查配置表是否存在记录，不存在则插入，存在则更新
                const { data, error } = await supabase
                    .from('config')
                    .select('id')
                    .single();

                if (error && error.code !== 'PGRST116') { // PGRST116表示没有找到记录
                    throw error;
                }

                if (data) {
                    // 更新
                    const { error: updateError } = await supabase
                        .from('config')
                        .update({ 
                            source_chats: sourceChats, 
                            target_chat: targetChat,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', data.id);
                    if (updateError) throw updateError;
                } else {
                    // 插入
                    const { error: insertError } = await supabase
                        .from('config')
                        .insert([{ 
                            source_chats: sourceChats, 
                            target_chat: targetChat,
                            created_at: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        }]);
                    if (insertError) throw insertError;
                }
                
                hideError('configError');
                alert('配置更新成功');
                loadConfig();
            } catch (error) {
                console.error('Error saving config:', error);
                showError('configError', '保存配置失败: ' + error.message);
            }
        }

        // 加载配置
        async function loadConfig() {
            if (!supabase && !initSupabase()) {
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('config')
                    .select('*')
                    .single();

                if (error && error.code !== 'PGRST116') {
                    throw error;
                }

                if (data) {
                    document.getElementById('sourceChat').value = data.source_chats.join(',');
                    document.getElementById('targetChat').value = data.target_chat;
                    document.getElementById('currentSource').textContent = data.source_chats.join(', ');
                    document.getElementById('currentTarget').textContent = data.target_chat;
                    
                    // 检查运行状态
                    const runningStatus = document.getElementById('runningStatus');
                    if (data.is_running) {
                        runningStatus.innerHTML = '<span class="status-indicator status-running"></span>运行中';
                    } else {
                        runningStatus.innerHTML = '<span class="status-indicator status-stopped"></span>已停止';
                    }
                }
                hideError('configError');
            } catch (error) {
                console.error('Error loading config:', error);
                showError('configError', '加载配置失败: ' + error.message);
            }
        }

        // 开始转移
        async function startTransfer() {
            if (!supabase && !initSupabase()) {
                return;
            }

            try {
                const { error } = await supabase
                    .from('config')
                    .update({ is_running: true })
                    .eq('id', 1);
                
                if (error) throw error;
                
                hideError('transferError');
                alert('转移任务已启动');
                loadConfig();
            } catch (error) {
                console.error('Error starting transfer:', error);
                showError('transferError', '启动转移失败: ' + error.message);
            }
        }

        // 停止转移
        async function stopTransfer() {
            if (!supabase && !initSupabase()) {
                return;
            }

            try {
                const { error } = await supabase
                    .from('config')
                    .update({ is_running: false })
                    .eq('id', 1);
                
                if (error) throw error;
                
                hideError('transferError');
                alert('转移任务已停止');
                loadConfig();
            } catch (error) {
                console.error('Error stopping transfer:', error);
                showError('transferError', '停止转移失败: ' + error.message);
            }
        }

        // 加载日志
        async function loadLogs() {
            if (!supabase && !initSupabase()) {
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('logs')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(50);

                if (error) throw error;

                const logsList = document.getElementById('logsList');
                logsList.innerHTML = '';

                if (data && data.length > 0) {
                    data.forEach(log => {
                        const logItem = document.createElement('div');
                        logItem.className = `log-item ${log.action}`;
                        const time = new Date(log.created_at).toLocaleString();
                        logItem.textContent = `[${time}] ${log.username || '未知用户'} (${log.user_id}) - ${log.chat_name} - ${log.action}: ${log.message}`;
                        logsList.appendChild(logItem);
                    });
                } else {
                    logsList.innerHTML = '<div class="log-item">暂无日志记录</div>';
                }
                
                hideError('logsError');
            } catch (error) {
                console.error('Error loading logs:', error);
                showError('logsError', '加载日志失败: ' + error.message);
            }
        }

        // 页面加载时初始化
        window.onload = function() {
            // 从localStorage加载API配置
            const savedApiUrl = localStorage.getItem('apiUrl');
            if (savedApiUrl) {
                SUPABASE_URL = savedApiUrl;
                document.getElementById('apiUrl').value = savedApiUrl;
            }
            
            // 初始化Supabase
            initSupabase();
            
            // 加载配置和日志
            loadConfig();
            loadLogs();
            
            // 每10秒刷新一次日志和状态
            setInterval(() => {
                loadLogs();
                loadConfig();
            }, 10000);
        };
    </script>
</body>
</html>
