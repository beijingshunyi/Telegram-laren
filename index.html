<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram群组用户转移工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <header class="text-center mb-10">
            <h1 class="text-2xl md:text-3xl font-bold mb-2">
                <i class="fa fa-telegram text-primary mr-2"></i>Telegram群组用户转移工具
            </h1>
            <p class="text-gray-600">轻松将成员从一个群组转移到另一个群组</p>
        </header>

        <main class="bg-white rounded-xl shadow p-6 md:p-8 mb-8">
            <!-- 群组设置 -->
            <div class="mb-8">
                <h2 class="text-xl font-semibold mb-4">群组设置</h2>
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">源群组ID</label>
                        <input 
                            type="text" 
                            id="sourceGroup" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                            value="-2651659549"
                        >
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">目标群组ID</label>
                        <input 
                            type="text" 
                            id="targetGroup" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                            value="-1002735235059"
                        >
                    </div>
                </div>
            </div>

            <!-- 操作按钮 -->
            <div class="mb-8 text-center">
                <button 
                    id="startTransfer" 
                    class="bg-primary hover:bg-primary/90 text-white font-medium px-6 py-3 rounded-lg shadow hover:shadow-lg transition-all"
                >
                    <i class="fa fa-play mr-2"></i>开始转移用户
                </button>
            </div>

            <!-- 转移状态 -->
            <div class="mb-8">
                <h2 class="text-xl font-semibold mb-4">转移状态</h2>
                <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                    <div class="mb-4">
                        <div class="flex justify-between text-sm mb-1">
                            <span>转移进度</span>
                            <span id="progressPercent">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3">
                            <div id="progressBar" class="bg-primary h-3 rounded-full transition-all" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                        <div class="bg-blue-50 p-3 rounded-lg">
                            <p class="text-sm text-gray-600">总用户数</p>
                            <p id="totalUsers" class="text-xl font-semibold text-primary">0</p>
                        </div>
                        <div class="bg-green-50 p-3 rounded-lg">
                            <p class="text-sm text-gray-600">已转移</p>
                            <p id="transferredUsers" class="text-xl font-semibold text-success">0</p>
                        </div>
                        <div class="bg-yellow-50 p-3 rounded-lg">
                            <p class="text-sm text-gray-600">已跳过</p>
                            <p id="skippedUsers" class="text-xl font-semibold text-yellow-500">0</p>
                        </div>
                        <div class="bg-purple-50 p-3 rounded-lg">
                            <p class="text-sm text-gray-600">状态</p>
                            <p id="transferStatus" class="text-xl font-semibold text-gray-600">未开始</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 操作日志 -->
            <div>
                <h2 class="text-xl font-semibold mb-4">操作日志</h2>
                <div id="logContainer" class="bg-gray-900 text-gray-200 rounded-lg p-4 h-60 overflow-y-auto text-sm font-mono">
                    <p class="text-gray-400">等待操作开始...</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        // ################## 关键：替换为您的实际Worker地址 ##################
        const API_BASE_URL = 'https://<worker-name>.<your-account-subdomain>.workers.dev
'; 
        let statusPollInterval = null;

        // DOM元素
        const startBtn = document.getElementById('startTransfer');
        const progressBar = document.getElementById('progressBar');
        const progressPercent = document.getElementById('progressPercent');
        const totalUsers = document.getElementById('totalUsers');
        const transferredUsers = document.getElementById('transferredUsers');
        const skippedUsers = document.getElementById('skippedUsers');
        const transferStatus = document.getElementById('transferStatus');
        const logContainer = document.getElementById('logContainer');
        const sourceGroupInput = document.getElementById('sourceGroup');
        const targetGroupInput = document.getElementById('targetGroup');

        // 添加日志
        function addLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('p');
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // 更新状态显示
        function updateStatus(status) {
            progressBar.style.width = `${status.progress}%`;
            progressPercent.textContent = `${status.progress}%`;
            totalUsers.textContent = status.total || 0;
            transferredUsers.textContent = status.transferred || 0;
            skippedUsers.textContent = status.skipped || 0;

            if (status.in_progress) {
                transferStatus.textContent = '转移中';
                transferStatus.className = 'text-xl font-semibold text-primary';
                startBtn.disabled = true;
            } else {
                transferStatus.textContent = status.progress === 100 ? '已完成' : '未开始';
                transferStatus.className = status.progress === 100 
                    ? 'text-xl font-semibold text-success' 
                    : 'text-xl font-semibold text-gray-600';
                startBtn.disabled = false;
            }
        }

        // 获取当前状态（带预检请求处理）
        async function getStatus() {
            try {
                // 先发送OPTIONS预检请求（确保CORS通过）
                await fetch(`${API_BASE_URL}/status`, { method: 'OPTIONS' });
                
                // 再发送实际GET请求
                const response = await fetch(`${API_BASE_URL}/status`, {
                    method: 'GET',
                    mode: 'cors',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    addLog(`服务器错误 (${response.status}): ${await response.text()}`);
                    return;
                }
                
                try {
                    const status = await response.json();
                    updateStatus(status);
                    return status;
                } catch (e) {
                    addLog(`服务器返回非JSON数据: ${await response.text()}`);
                }
            } catch (error) {
                addLog(`获取状态失败: ${error.message}`);
                // 详细错误分析
                if (error.message.includes('CORS')) {
                    addLog('CORS错误：请检查Worker的ALLOWED_ORIGIN配置');
                } else if (error.message.includes('404')) {
                    addLog('404错误：Worker地址不正确，请检查URL');
                }
            }
        }

        // 开始转移（带预检请求处理）
        async function startTransfer() {
            const sourceGroup = sourceGroupInput.value.trim();
            const targetGroup = targetGroupInput.value.trim();

            if (!sourceGroup || !targetGroup) {
                addLog('错误：请输入源群组和目标群组ID');
                return;
            }

            try {
                // 先发送OPTIONS预检请求
                await fetch(`${API_BASE_URL}/transfer`, { method: 'OPTIONS' });
                
                // 再发送实际POST请求（FormData格式）
                const formData = new FormData();
                formData.append('source', sourceGroup);
                formData.append('target', targetGroup);

                const response = await fetch(`${API_BASE_URL}/transfer`, {
                    method: 'POST',
                    mode: 'cors',
                    body: formData
                });

                if (!response.ok) {
                    addLog(`转移请求失败 (${response.status}): ${await response.text()}`);
                    return;
                }

                addLog('开始转移用户...');
                startStatusPolling();
            } catch (error) {
                addLog(`开始转移失败: ${error.message}`);
                if (error.message.includes('CORS')) {
                    addLog('CORS错误：请检查Worker的CORS配置');
                } else if (error.message.includes('404')) {
                    addLog('404错误：Worker地址不正确');
                }
            }
        }

        // 开始轮询状态
        function startStatusPolling() {
            if (statusPollInterval) clearInterval(statusPollInterval);
            getStatus();
            statusPollInterval = setInterval(getStatus, 3000);
        }

        // 事件监听
        startBtn.addEventListener('click', startTransfer);

        // 页面加载时执行
        window.addEventListener('load', () => {
            addLog('页面已加载，准备就绪');
            // 检查Worker地址是否正确配置
            if (API_BASE_URL.includes('your-account-subdomain')) {
                addLog('警告：请替换API_BASE_URL为您的实际Worker地址');
            }
            getStatus();
        });
    </script>
</body>
</html>
    
