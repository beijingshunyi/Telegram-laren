<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram 群组用户转移工具</title>
    <!-- 引入Tailwind CSS实现快速样式设计 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入Font Awesome图标 -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <style>
        /* 进度条动画 */
        @keyframes progressMove {
            from { width: 0; }
            to { width: var(--progress-width); }
        }
        .progress-bar {
            transition: width 0.5s ease;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 md:p-8">
    <div class="max-w-3xl mx-auto bg-white rounded-xl shadow-md overflow-hidden">
        <!-- 头部标题 -->
        <div class="bg-blue-600 text-white p-6">
            <h1 class="text-2xl md:text-3xl font-bold flex items-center">
                <i class="fa fa-exchange mr-3"></i>Telegram 群组用户转移工具
            </h1>
            <p class="mt-2 opacity-90">将源群组用户批量转移至目标群组（支持实时进度监控）</p>
        </div>

        <!-- 配置区域 -->
        <div class="p-6 border-b border-gray-100">
            <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                <i class="fa fa-cog text-blue-600 mr-2"></i>基本配置
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- 服务器地址 -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">服务器地址</label>
                    <input 
                        type="text" 
                        id="serverUrl" 
                        placeholder="http://EC2公网IP:8002" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        value="http://3.26.45.31:8002"  <!-- 替换为你的EC2公网IP+端口 -->
                    >
                </div>
                <!-- 源群组ID -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">源群组ID</label>
                    <input 
                        type="text" 
                        id="sourceGroup" 
                        placeholder="如: -2651659549" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                </div>
                <!-- 目标群组ID -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">目标群组ID</label>
                    <input 
                        type="text" 
                        id="targetGroup" 
                        placeholder="如: -1002735235059" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                </div>
                <!-- Bot Token (可选，前端仅展示，实际在后端配置) -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Bot Token（后端已配置）</label>
                    <input 
                        type="text" 
                        placeholder="已在后端配置，此处无需填写" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50 cursor-not-allowed"
                        disabled
                    >
                </div>
            </div>
        </div>

        <!-- 操作按钮区域 -->
        <div class="p-6 border-b border-gray-100 flex flex-wrap gap-3">
            <button 
                id="startBtn" 
                class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition flex items-center"
            >
                <i class="fa fa-play mr-2"></i>开始转移用户
            </button>
            <button 
                id="stopBtn" 
                class="px-6 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition flex items-center"
                disabled
            >
                <i class="fa fa-stop mr-2"></i>停止转移
            </button>
            <button 
                id="resetBtn" 
                class="px-6 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition flex items-center"
            >
                <i class="fa fa-refresh mr-2"></i>重置状态
            </button>
        </div>

        <!-- 状态展示区域 -->
        <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- 进度条和核心状态 -->
            <div>
                <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                    <i class="fa fa-tachometer text-blue-600 mr-2"></i>转移进度
                </h2>
                <!-- 进度条容器 -->
                <div class="w-full bg-gray-200 rounded-full h-4 mb-2">
                    <div id="progressBar" class="progress-bar bg-green-500 h-4 rounded-full" style="width: 0%"></div>
                </div>
                <!-- 进度百分比 -->
                <div class="text-right text-sm text-gray-600 mb-6">
                    当前进度: <span id="progressText" class="font-bold text-green-600">0%</span>
                </div>

                <!-- 状态卡片 -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
                        <p class="text-sm text-gray-600 mb-1">总用户数</p>
                        <p id="totalUsers" class="text-2xl font-bold text-blue-600">0</p>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg border border-green-100">
                        <p class="text-sm text-gray-600 mb-1">已转移</p>
                        <p id="transferredUsers" class="text-2xl font-bold text-green-600">0</p>
                    </div>
                    <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-100">
                        <p class="text-sm text-gray-600 mb-1">已跳过</p>
                        <p id="skippedUsers" class="text-2xl font-bold text-yellow-600">0</p>
                    </div>
                    <div class="bg-purple-50 p-4 rounded-lg border border-purple-100">
                        <p class="text-sm text-gray-600 mb-1">转移状态</p>
                        <p id="transferStatus" class="text-2xl font-bold text-purple-600">未开始</p>
                    </div>
                </div>
            </div>

            <!-- 操作日志 -->
            <div>
                <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                    <i class="fa fa-history text-blue-600 mr-2"></i>操作日志
                </h2>
                <div id="logContainer" class="w-full h-64 bg-gray-50 border border-gray-200 rounded-md p-3 overflow-y-auto text-sm">
                    <div class="text-gray-500">等待转移开始...</div>
                </div>
            </div>
        </div>

        <!-- 底部说明 -->
        <div class="p-6 bg-gray-50 border-t border-gray-100">
            <h3 class="font-semibold text-gray-800 mb-2">注意事项：</h3>
            <ul class="text-sm text-gray-600 list-disc pl-5 space-y-1">
                <li>确保后端Bot已加入源群组和目标群组，并拥有管理员权限（开启"添加成员"权限）</li>
                <li>群组ID格式为负数（如：-1001234567890），可通过 @getidsbot 获取</li>
                <li>转移过程中请勿关闭页面，否则将无法实时监控进度</li>
                <li>已跳过用户包括：Bot账户、拒绝被添加的用户、已在目标群组的用户</li>
            </ul>
        </div>
    </div>

    <script>
        // 页面元素获取
        const serverUrlInput = document.getElementById('serverUrl');
        const sourceGroupInput = document.getElementById('sourceGroup');
        const targetGroupInput = document.getElementById('targetGroup');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const resetBtn = document.getElementById('resetBtn');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const totalUsersEl = document.getElementById('totalUsers');
        const transferredUsersEl = document.getElementById('transferredUsers');
        const skippedUsersEl = document.getElementById('skippedUsers');
        const transferStatusEl = document.getElementById('transferStatus');
        const logContainer = document.getElementById('logContainer');

        // 全局变量
        let statusPolling = null; // 状态轮询定时器
        let isTransferring = false; // 是否正在转移

        // 日志添加函数
        function addLog(message, isError = false) {
            const logItem = document.createElement('div');
            logItem.className = `mb-1 ${isError ? 'text-red-600' : 'text-gray-800'}`;
            logItem.innerHTML = `<span class="text-gray-500">[${new Date().toLocaleTimeString()}]</span> ${message}`;
            logContainer.appendChild(logItem);
            // 滚动到底部
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // 重置所有状态
        function resetAllStatus() {
            // 清除定时器
            if (statusPolling) {
                clearInterval(statusPolling);
                statusPolling = null;
            }
            // 重置UI
            progressBar.style.width = '0%';
            progressText.textContent = '0%';
            totalUsersEl.textContent = '0';
            transferredUsersEl.textContent = '0';
            skippedUsersEl.textContent = '0';
            transferStatusEl.textContent = '未开始';
            transferStatusEl.className = 'text-2xl font-bold text-purple-600';
            // 重置按钮状态
            startBtn.disabled = false;
            stopBtn.disabled = true;
            // 重置变量
            isTransferring = false;
            // 添加日志
            addLog('状态已重置');
        }

        // 更新状态显示
        function updateStatus(statusData) {
            const { progress, total, transferred, skipped, in_progress, error } = statusData;
            
            // 处理错误
            if (error) {
                addLog(`转移出错: ${error}`, true);
                resetAllStatus();
                transferStatusEl.textContent = '转移失败';
                transferStatusEl.className = 'text-2xl font-bold text-red-600';
                return;
            }

            // 更新进度
            const progressPercent = Math.min(progress, 100);
            progressBar.style.width = `${progressPercent}%`;
            progressText.textContent = `${progressPercent}%`;
            
            // 更新统计数据
            totalUsersEl.textContent = total || 0;
            transferredUsersEl.textContent = transferred || 0;
            skippedUsersEl.textContent = skipped || 0;
            
            // 更新转移状态文本
            if (in_progress) {
                isTransferring = true;
                transferStatusEl.textContent = '转移中';
                transferStatusEl.className = 'text-2xl font-bold text-blue-600';
                startBtn.disabled = true;
                stopBtn.disabled = false;
                addLog(`转移中 - 已完成${progressPercent}% (${transferred || 0}/${total || 0})`);
            } else {
                // 转移完成（且之前在转移中）
                if (isTransferring) {
                    transferStatusEl.textContent = '已完成';
                    transferStatusEl.className = 'text-2xl font-bold text-green-600';
                    addLog(`转移完成！共处理${total || 0}人，成功转移${transferred || 0}人，跳过${skipped || 0}人`);
                    resetAllStatus(); // 完成后自动重置（保留日志）
                }
            }
        }

        // 轮询获取状态
        function startStatusPolling() {
            // 每秒获取一次状态
            statusPolling = setInterval(async () => {
                const serverUrl = serverUrlInput.value.trim();
                if (!serverUrl) return;

                try {
                    const response = await fetch(`${serverUrl}/status`);
                    if (!response.ok) throw new Error(`HTTP错误: ${response.status}`);
                    const statusData = await response.json();
                    updateStatus(statusData);
                } catch (err) {
                    addLog(`获取状态失败: ${err.message}`, true);
                    clearInterval(statusPolling);
                    statusPolling = null;
                }
            }, 1000);
        }

        // 开始转移
        startBtn.addEventListener('click', async () => {
            const serverUrl = serverUrlInput.value.trim();
            const sourceGroup = sourceGroupInput.value.trim();
            const targetGroup = targetGroupInput.value.trim();

            // 表单验证
            if (!serverUrl) {
                addLog('请填写服务器地址', true);
                return;
            }
            if (!sourceGroup || !/^-\d+$/.test(sourceGroup)) {
                addLog('请填写有效的源群组ID（格式：-数字）', true);
                return;
            }
            if (!targetGroup || !/^-\d+$/.test(targetGroup)) {
                addLog('请填写有效的目标群组ID（格式：-数字）', true);
                return;
            }
            if (sourceGroup === targetGroup) {
                addLog('源群组和目标群组不能相同', true);
                return;
            }

            try {
                // 修正FormData处理方式
                const formData = new FormData();
                formData.append('source', sourceGroup);
                formData.append('target', targetGroup);
                
                // 发送转移请求
                const response = await fetch(`${serverUrl}/transfer`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                if (response.ok) {
                    addLog(`转移请求已发送：${result.message}`);
                    addLog(`源群组：${result.source} | 目标群组：${result.target}`);
                    // 开始轮询状态
                    startStatusPolling();
                } else {
                    addLog(`请求失败：${result.error}`, true);
                }
            } catch (err) {
                addLog(`发送请求失败：${err.message}`, true);
            }
        });

        // 停止转移（当前后端未实现停止接口，可后续扩展）
        stopBtn.addEventListener('click', () => {
            addLog('停止功能待后端扩展（当前仅重置状态）', true);
            resetAllStatus();
            // 后续可添加：调用后端 /stop 接口实现真正停止
        });

        // 重置按钮事件
        resetBtn.addEventListener('click', resetAllStatus);

        // 页面加载完成后初始化
        window.addEventListener('load', () => {
            addLog('页面加载完成，等待配置并开始转移');
        });
    </script>
</body>
</html>
